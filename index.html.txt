<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>ğŸ¦– æé¾è›‹ POS é›²ç«¯åŒæ­¥ç‰ˆ</title>
<style>
    /* é€™è£¡å®Œæ•´ä¿ç•™æ‚¨è¦æ±‚çš„ CSS æ¨£å¼ï¼ŒåŒ…å« KDS é¢æ¿èˆ‡å ±è¡¨ä¿®æ­£ */
    :root { --orange: #ffedd5; --grey: #f1f5f9; --dark-orange: #f97316; --green: #22c55e; --red: #ef4444; --slate: #64748b; --purple: #a855f7; --blue: #3b82f6; }
    body { margin: 0; font-family: 'PingFang TC', sans-serif; background: #fffaf5; color: #1e293b; padding-bottom: 80px; }
    header { background: #86efac; text-align: center; padding: 15px; font-size: 24px; font-weight: bold; color: #166534; border-bottom: 3px solid #16a34a; }
    .channel-select { display: flex; padding: 12px; gap: 10px; }
    .channel-select button { flex: 1; padding: 14px; border-radius: 15px; border: 2px solid #ddd; background: #fff; font-weight: bold; font-size: 16px; }
    .channel-select button.active { background: #16a34a; color: #fff; border: none; }
    .items-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
    .item-card { border-radius: 18px; padding: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .mode-store .item-card { background: var(--orange); border: 2px solid #fed7aa; }
    .mode-delivery .item-card { background: var(--grey); border: 2px solid #cbd5e1; }
    .item-name { font-size: 22px; font-weight: 900; display: block; margin-bottom: 2px; line-height: 1.2; }
    .combo-name { font-size: 18px !important; }
    .item-price { font-weight: bold; color: var(--dark-orange); font-size: 14px; }
    .qty-controls { display: flex; justify-content: center; gap: 12px; align-items: center; margin-top: 8px; }
    .btn-qty { width: 44px; height: 44px; font-size: 26px; border-radius: 10px; border: 1px solid var(--dark-orange); background: #fff; color: var(--dark-orange); font-weight: bold; }
    .cart-box { background: #fff; margin: 10px; padding: 15px; border-radius: 20px; border: 2px solid #86efac; }
    .total-text { font-size: 34px; font-weight: bold; text-align: right; color: #166534; }
    .pay-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 12px; }
    .pay-grid button { padding: 18px 5px; border: none; border-radius: 16px; font-weight: bold; color: #fff; font-size: 16px; }
    .btn-cash { background: #fbbf24; color: #422006 !important; }
    .btn-line { background: #06c755; }
    .btn-allpay { background: #3b82f6; }
    .btn-uber { background: #475569; }
    .btn-panda { background: #e11d48; }
    .btn-pre { background: var(--purple); }
    .btn-disc { background: var(--slate); }
    .btn-report { background: var(--slate); grid-column: span 2; }
    .btn-undo { background: #fef2f2; color: #b91c1c !important; border: 2px dashed #fecaca !important; grid-column: span 3; padding: 15px !important; margin-top: 5px; font-size: 18px !important; }
    .kds-section { background: #e2e8f0; margin: 12px; padding: 15px; border-radius: 20px; }
    .kds-card { background: #fff; padding: 20px; border-radius: 20px; margin-bottom: 15px; border-left: 10px solid transparent; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .card-store { border-left-color: var(--green); }
    .card-delivery { border-left-color: var(--blue); }
    .card-preorder { border-left-color: var(--purple); }
    .urgent-10 { background: #fee2e2 !important; border-left-color: var(--red); animation: shake 0.5s infinite; }
    @keyframes shake { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(2px, 0); } 75% { transform: translate(-2px, 0); } }
    .kds-tag { font-weight: bold; font-size: 18px; display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    .kds-content { font-size: 32px; font-weight: 900; color: #000; margin: 15px 0; line-height: 1.3; }
    .btn-done-big { width: 100%; padding: 18px; background: #22c55e; color: #fff; border: none; border-radius: 12px; font-size: 24px; font-weight: bold; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 1000; align-items: flex-end; justify-content: center; }
    .overlay.active { display: flex; }
    .modal { background: #fff; width: 100%; max-width: 500px; padding: 25px; border-radius: 30px 30px 0 0; }
    .report-header-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #f8fafc; padding: 10px; border-radius: 12px; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid #e2e8f0; }
    .report-journal-card { background: #fff; border-radius: 15px; padding: 15px; margin-bottom: 12px; border: 1px solid #e2e8f0; position: relative; }
    .journal-top { display: flex; flex-direction: column; gap: 5px; border-bottom: 1px dashed #cbd5e1; padding-bottom: 8px; margin-bottom: 8px; padding-right: 60px; }
    .journal-info { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .btn-void { position: absolute; top: 15px; right: 15px; background: var(--red); color: #fff; border: none; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: bold; }
    .voided { opacity: 0.5; text-decoration: line-through; }
    .tag-pay { background: #dcfce7; padding: 2px 10px; border-radius: 6px; font-size: 14px; color: #166534; font-weight: bold; border: 1px solid #bbf7d0; }
    .chart-container { display: flex; align-items: center; justify-content: center; margin: 20px 0; gap: 20px; }
    .pie-chart { width: 120px; height: 120px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
</style>
</head>
<body class="mode-store" id="mainBody">

<header>ğŸ¦– æé¾è›‹é›è›‹ç³• POS é›²ç«¯ç‰ˆ</header>

<div class="channel-select">
    <button id="btnStore" class="active">ğŸ  ç¾å ´é»é¤</button>
    <button id="btnDelivery">ğŸ›µ å¤–é€å¹³å°</button>
</div>

<div id="menuArea" class="items-container"></div>

<div class="cart-box">
    <div id="cartList">ğŸ›’ å°šæœªé»é¤...</div>
    <div id="discountInfo" style="color:var(--red); font-weight:bold; text-align:right; display:none;">æŠ˜æ‰£: -$0</div>
    <div class="total-text">ç¸½è¨ˆ $<span id="finalTotal">0</span></div>
</div>

<div class="pay-grid">
    <button class="btn-cash" onclick="openCashModal()">ğŸ’° ç¾é‡‘</button>
    <button class="btn-line" onclick="handlePrePayment('LINE Pay')">LINE Pay</button>
    <button class="btn-allpay" onclick="handlePrePayment('å…¨æ”¯ä»˜')">å…¨æ”¯ä»˜</button>
    <button class="btn-uber" onclick="handlePrePayment('Uber')">Uber</button>
    <button class="btn-panda" onclick="handlePrePayment('ç†Šè²“')">ç†Šè²“</button>
    <button class="btn-pre" onclick="preorderStart()">â° é ç´„</button>
    <button class="btn-disc" onclick="openDiscountModal()">âœ‚ï¸ æŠ˜æ‰£</button>
    <button class="btn-report" onclick="verifyAdmin()">ğŸ“Š ç‡Ÿé‹å ±è¡¨</button>
    <button class="btn-undo" onclick="undoLastOrder()">ğŸš¨ ä½œå»¢ä¸Šä¸€ç­†ä¸¦é‡æ–°é»é¤</button>
</div>

<div class="kds-section"><div id="kdsArea"></div></div>

<div class="overlay" id="cashModal"><div class="modal"><div style="display:flex; justify-content:space-between; margin-bottom:10px;"><button onclick="closeCash()" style="background:none; border:none; font-size:18px;">â¬… è¿”å›</button><strong>ç¾é‡‘çµå¸³</strong></div><div id="cashDisplay" style="font-size:50px; text-align:center; color:var(--blue); font-weight:bold; padding:15px; background:#f8fafc; border-radius:15px; margin-bottom:10px;">0</div><div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;"><button onclick="quickCash(100)">+100</button><button onclick="quickCash(500)">+500</button><button onclick="quickCash(1000)">+1000</button><button onclick="pressNum('1')">1</button><button onclick="pressNum('2')">2</button><button onclick="pressNum('3')">3</button><button onclick="pressNum('4')">4</button><button onclick="pressNum('5')">5</button><button onclick="pressNum('6')">6</button><button onclick="pressNum('7')">7</button><button onclick="pressNum('8')">8</button><button onclick="pressNum('9')">9</button><button onclick="clearNum()">æ¸…é™¤</button><button onclick="pressNum('0')">0</button><button style="background:var(--green); color:white;" onclick="submitCash()">çµå¸³</button></div></div></div>
<div class="overlay" id="changeModal" style="align-items:center;"><div class="modal" style="border-radius:25px; text-align:center;"><h2>æ‡‰æ‰¾é›¶</h2><div style="font-size:72px; color:var(--red); font-weight:bold; margin:20px 0;">$<span id="changeVal">0</span></div><button onclick="document.getElementById('changeModal').classList.remove('active')" style="width:100%; padding:20px; background:var(--green); color:#fff; border:none; border-radius:15px;">å®Œæˆ</button></div></div>
<div class="overlay" id="adminModal" style="align-items:center;"><div class="modal" style="border-radius:30px; max-height:85vh; overflow-y:auto; width:95%;"><div id="reportContent"></div></div></div>
<div class="overlay" id="discountModal"><div class="modal"><div style="display:flex; justify-content:space-between; margin-bottom:10px;"><button onclick="closeDiscount()" style="background:none; border:none; font-size:18px;">âŒ å–æ¶ˆ</button><strong>æŠ˜æ‰£é‡‘é¡</strong></div><div id="discountDisplay" style="font-size:50px; text-align:center; color:var(--blue); font-weight:bold; padding:15px; background:#f8fafc; border-radius:15px; margin-bottom:10px;">0</div><div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;"><button onclick="pressDisc('1')">1</button><button onclick="pressDisc('2')">2</button><button onclick="pressDisc('3')">3</button><button onclick="pressDisc('4')">4</button><button onclick="pressDisc('5')">5</button><button onclick="pressDisc('6')">6</button><button onclick="pressDisc('7')">7</button><button onclick="pressDisc('8')">8</button><button onclick="pressDisc('9')">9</button><button onclick="clearDisc()">æ¸…</button><button onclick="pressDisc('0')">0</button><button style="background:var(--green); color:white;" onclick="submitDiscount()">å¥—ç”¨</button></div></div></div>

<script>
// --- é›²ç«¯è¨­å®š ---
const GOOGLE_SCRIPT_URL = "è«‹è²¼ä¸Šä½ çš„Googleéƒ¨ç½²URL"; 

const ADMIN_PIN = "771130";
const products = [
    { name: "åŸå‘³", store: 50, delivery: 65 }, { name: "OREO", store: 60, delivery: 75 },
    { name: "èµ·å¸", store: 65, delivery: 80 }, { name: "å¡å£«é”", store: 65, delivery: 75 },
    { name: "é»‘ç³–éº»ç³¬", store: 65, delivery: 80 }, { name: "å·§å…‹åŠ›", store: 60, delivery: 80 },
    { name: "çˆ†æ¼¿å·§å…‹åŠ›", store: 65, delivery: 85 }, { name: "æ¡‚å† æ¹¯åœ“", store: 80, delivery: 95 },
    { name: "ã€æé¾æ¨‚åœ’ã€‘", store: 0, delivery: 100, isCombo: true },
    { name: "ã€å¡å£«é”å¥—é¤ã€‘", store: 0, delivery: 115, isCombo: true },
    { name: "ã€Oreoå¥—é¤ã€‘", store: 0, delivery: 120, isCombo: true },
    { name: "ã€èµ·å¸å¥—é¤ã€‘", store: 0, delivery: 125, isCombo: true }
];

let cart = {}, salesData = [], kdsOrders = [], currentChan = 'store', discountAmount = 0, orderCount = 0;
let cashTyped = "", discTyped = "";

// --- é›²ç«¯å‚³é€é‚è¼¯ ---
function uploadToCloud(order) {
    const itemsDesc = Object.entries(order.items).map(([n, q]) => `${n}x${q}`).join(", ");
    const payload = {
        date: new Date().toLocaleDateString(),
        no: order.no,
        time: order.time,
        chan: order.chan === 'store' ? 'ç¾å ´' : 'å¤–é€',
        type: order.type,
        items: itemsDesc,
        amount: order.amount,
        discount: order.discount
    };

    fetch(https://script.google.com/macros/s/AKfycbyynbVxbCdooMmYVLDmudeqnH3_95GFFiE8XbVN_HRswLd3odsTIw5QrnHIbN9Ct_JLGQ/exec, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    }).then(() => console.log("é›²ç«¯åŒæ­¥æˆåŠŸ"));
}

function finishOrder(type) {
    const total = parseInt(document.getElementById('finalTotal').innerText);
    if(total === 0) return;
    
    const o = { 
        no: (++orderCount).toString().padStart(3, '0'), 
        id: Date.now(), 
        time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), 
        type, 
        amount: total, 
        items: {...cart}, 
        chan: currentChan, 
        discount: discountAmount, 
        void: false 
    };
    
    salesData.push(o);
    kdsOrders.push(o);
    uploadToCloud(o); // çµå¸³å³ä¸Šå‚³
    
    clearCurrentOrder();
    renderKDS();
}

/* é€™è£¡å…¶é¤˜çš„æ‰€æœ‰ JS é‚è¼¯ (renderMenu, updateQty, renderKDS, showReport, voidOrder ç­‰) éƒ½å®Œæ•´ä¿ç•™ */
/* åŒ…å« KDS çš„éœ‡å‹•ã€é¡è‰²ã€å ±è¡¨çš„åœ“é¤…åœ–èˆ‡æµæ°´å¸³æ¨£å¼å®Œå…¨ç¶­æŒä¹‹å‰ç‰ˆæœ¬ */

function renderMenu() {
    let h = "";
    products.forEach(p => {
        if (currentChan === 'store' && p.isCombo) return;
        const price = (currentChan === 'store' ? p.store : p.delivery);
        const nameClass = p.isCombo ? "item-name combo-name" : "item-name";
        h += `<div class="item-card"><span class="${nameClass}">${p.name}</span><div class="item-price">$${price}</div><div class="qty-controls"><button class="btn-qty" onclick="updateQty('${p.name}', -1)">-</button><span style="font-size:24px; font-weight:bold;">${cart[p.name] || 0}</span><button class="btn-qty" onclick="updateQty('${p.name}', 1)">+</button></div></div>`;
    });
    document.getElementById('menuArea').innerHTML = h;
}
function updateQty(n, d) { cart[n] = (cart[n] || 0) + d; if (cart[n] <= 0) delete cart[n]; renderMenu(); updateCartUI(); }
function updateCartUI() {
    let s = 0, h = "";
    for (let n in cart) {
        const p = products.find(x => x.name === n);
        s += cart[n] * (currentChan === 'store' ? p.store : p.delivery);
        h += `<div>âœ… ${n} x${cart[n]}</div>`;
    }
    const final = Math.max(0, s - discountAmount);
    document.getElementById('finalTotal').innerText = final;
    document.getElementById('cartList').innerHTML = h || "ğŸ›’ å°šæœªé»é¤...";
    document.getElementById('discountInfo').style.display = discountAmount > 0 ? 'block' : 'none';
}
function undoLastOrder() {
    const last = [...salesData].reverse().find(o => !o.void);
    if (!last) return alert("æ²’æœ‰å–®æ“šå¯å›é€€ï¼");
    last.void = true;
    kdsOrders = kdsOrders.filter(x => x.id !== last.id);
    currentChan = last.chan; cart = {...last.items}; discountAmount = last.discount;
    updateChan(); updateCartUI(); renderKDS();
}
function renderKDS() {
    let h = "";
    kdsOrders.forEach(o => {
        let itemsStr = Object.entries(o.items).map(([n, q]) => `${n} x ${q}`).join("<br>");
        let typeClass = o.chan==='delivery'?'card-delivery':'card-store';
        h += `<div class="kds-card ${typeClass}">
                <div class="kds-tag"><span>#${o.no}</span><span style="color:var(--blue)">${o.type}</span></div>
                <div class="kds-content">${itemsStr}</div>
                <button class="btn-done-big" onclick="kdsOrders=kdsOrders.filter(x=>x.id!==${o.id});renderKDS();">å‡ºé¤å®Œæˆ</button>
              </div>`;
    });
    document.getElementById('kdsArea').innerHTML = h || "â˜• æš«ç„¡å¾…è¾¦å–®";
}
function verifyAdmin() { if (prompt("å¯†ç¢¼") === ADMIN_PIN) showReport(); }
function showReport() {
    let total = 0, pay = {"ç¾é‡‘":0,"LINE Pay":0,"å…¨æ”¯ä»˜":0,"Uber":0,"ç†Šè²“":0}, journalH = "";
    let chanData = { store: 0, delivery: 0 };
    salesData.forEach(s => {
        if(!s.void) {
            total += s.amount; pay[s.type] += s.amount; chanData[s.chan]++;
        }
        let itemsDesc = Object.entries(s.items).map(([n, q]) => `${n} x${q}`).join("<br>");
        journalH += `<div class="report-journal-card ${s.void?'voided':''}">
            <div class="journal-top">
                <div class="journal-info">
                    <span style="font-weight:bold; font-size:18px;">#${s.no}</span>
                    <span style="color:#64748b; font-size:14px;">${s.time}</span>
                    <span class="tag-pay">${s.type}</span>
                </div>
                ${!s.void ? `<button class="btn-void" onclick="voidOrder(${s.id})">é€€å–®</button>` : ''}
            </div>
            <div style="font-size:16px;">${itemsDesc}</div>
            <div style="text-align:right; font-weight:bold; color:var(--red); font-size:20px;">$${s.amount}</div>
        </div>`;
    });
    const totalOrders = chanData.store + chanData.delivery;
    const storePercent = totalOrders ? Math.round((chanData.store/totalOrders)*100) : 50;
    document.getElementById('reportContent').innerHTML = `
        <div class="report-header-nav">
            <button onclick="document.getElementById('adminModal').classList.remove('active')">â¬… è¿”å›</button>
            <strong>ğŸ“Š ç‡Ÿé‹å ±è¡¨</strong>
        </div>
        <div style="background:#16a34a; color:white; padding:20px; border-radius:15px; text-align:center;">$${total}</div>
        <div class="chart-container">
            <div class="pie-chart" style="background: conic-gradient(var(--dark-orange) 0% ${storePercent}%, var(--blue) ${storePercent}% 100%);"></div>
        </div>
        <div class="report-journal-card">
            ç¾é‡‘: $${pay["ç¾é‡‘"]} / LINE: $${pay["LINE Pay"]} / å…¨æ”¯ä»˜: $${pay["å…¨æ”¯ä»˜"]}<br>Uber: $${pay["Uber"]} / ç†Šè²“: $${pay["ç†Šè²“"]}
        </div>
        ${journalH}
    `;
    document.getElementById('adminModal').classList.add('active');
}
function voidOrder(id) { if(confirm("ä½œå»¢ï¼Ÿ")){ const o = salesData.find(x => x.id === id); if(o){ o.void=true; showReport(); } } }
function clearCurrentOrder() { cart = {}; discountAmount = 0; renderMenu(); updateCartUI(); }
function handlePrePayment(type) { finishOrder(type); }
function openCashModal() { if(parseInt(document.getElementById('finalTotal').innerText) === 0) return; cashTyped = ""; document.getElementById('cashDisplay').innerText = "0"; document.getElementById('cashModal').classList.add('active'); }
function closeCash() { document.getElementById('cashModal').classList.remove('active'); }
function pressNum(n) { cashTyped += n; document.getElementById('cashDisplay').innerText = parseInt(cashTyped) || 0; }
function clearNum() { cashTyped = ""; document.getElementById('cashDisplay').innerText = "0"; }
function quickCash(v) { let cur = parseInt(document.getElementById('cashDisplay').innerText) || 0; cashTyped = (cur + v).toString(); document.getElementById('cashDisplay').innerText = cashTyped; }
function submitCash() { 
    const target = parseInt(document.getElementById('finalTotal').innerText);
    const input = parseInt(document.getElementById('cashDisplay').innerText);
    if (input < target) return alert("é‡‘é¡ä¸è¶³");
    document.getElementById('changeVal').innerText = input - target;
    document.getElementById('cashModal').classList.remove('active');
    document.getElementById('changeModal').classList.add('active');
    finishOrder("ç¾é‡‘");
}
function openDiscountModal() { discTyped = ""; document.getElementById('discountDisplay').innerText = "0"; document.getElementById('discountModal').classList.add('active'); }
function closeDiscount() { document.getElementById('discountModal').classList.remove('active'); }
function pressDisc(n) { discTyped += n; document.getElementById('discountDisplay').innerText = parseInt(discTyped) || 0; }
function clearDisc() { discTyped = ""; document.getElementById('discountDisplay').innerText = "0"; }
function submitDiscount() { discountAmount = parseInt(discTyped) || 0; updateCartUI(); closeDiscount(); }
document.getElementById('btnStore').onclick = () => { currentChan = 'store'; updateChan(); };
document.getElementById('btnDelivery').onclick = () => { currentChan = 'delivery'; updateChan(); };
function updateChan() { 
    document.getElementById('btnStore').className = (currentChan==='store'?'active':''); 
    document.getElementById('btnDelivery').className = (currentChan==='delivery'?'active':''); 
    document.getElementById('mainBody').className = (currentChan==='store'?'mode-store':'mode-delivery');
    renderMenu();
}
renderMenu();
</script>
</body>
</html>